# Association Utilisateur WordPress ‚Üí Club - Documentation

Cette fonctionnalit√© permet d'associer un utilisateur WordPress √† un club, tant depuis l'interface d'administration que lors de l'affiliation frontend, garantissant un contr√¥le d'acc√®s s√©curis√© pour l'espace club.

## üìã Fonctionnalit√©s impl√©ment√©es

### 1. Interface d'administration

#### Formulaire de club (Cr√©ation/Modification)
- **Emplacement** : `includes/clubs/form-club.php`
- **Champ ajout√©** : "Utilisateur WordPress associ√©" (visible uniquement en admin)
- **Fonctionnalit√©s** :
  - Liste d√©roulante avec tous les utilisateurs WordPress
  - Affichage : Nom d'affichage (login) - email
  - Pr√©vention des associations multiples (utilisateurs d√©j√† associ√©s sont d√©sactiv√©s)
  - Affichage de l'utilisateur actuellement associ√©

#### Liste des clubs
- **Emplacement** : `includes/clubs/admin-club-list-page.php`
- **Colonne ajout√©e** : "Utilisateur associ√©"
- **Affichage** :
  - Nom d'affichage de l'utilisateur
  - Login WordPress
  - Adresse email
  - Gestion des cas d'erreur (utilisateur supprim√©, aucun utilisateur)

#### Profil utilisateur WordPress
- **Emplacement** : `includes/admin/user-profile-enhancement.php`
- **Champ ajout√©** : "Club associ√©" dans la page d'√©dition d'utilisateur
- **Fonctionnalit√©s** :
  - Liste d√©roulante avec tous les clubs disponibles
  - Synchronisation bidirectionnelle avec la table des clubs
  - Validation de l'unicit√© (un utilisateur = un club, un club = un utilisateur)
  - Gestion transactionnelle pour √©viter les incoh√©rences

### 2. Interface frontend (Affiliation)

#### Cr√©ation d'utilisateur pendant l'affiliation
- **Emplacement** : `includes/clubs/form-club.php` (section frontend)
- **Options disponibles** :
  - **Utiliser le compte actuel** : Associe l'utilisateur connect√© au club
  - **Cr√©er un nouveau compte** : Cr√©e automatiquement un utilisateur WordPress
  - **Associer un compte existant** : S√©lectionne un utilisateur existant non associ√©
- **Fonctionnalit√©s** :
  - Interface JavaScript responsive avec champs conditionnels
  - Cr√©ation automatique de mot de passe et envoi par email
  - Validation des doublons (nom d'utilisateur et email)
  - Pr√©vention des associations multiples

### 3. Validation et s√©curit√©

#### Contr√¥leur de sauvegarde
- **Emplacement** : `includes/controllers/save-club.php`
- **Validations ajout√©es** :
  - V√©rification de l'existence de l'utilisateur s√©lectionn√©
  - Pr√©vention des associations multiples avec message d'erreur explicite
  - Gestion des permissions admin uniquement pour modification
  - Support cr√©ation et modification de clubs
  - Gestion diff√©renci√©e frontend/backend

#### Fonctions helper
- **Emplacement** : `includes/helpers.php`
- **Nouvelles fonctions** :
  - `ufsc_handle_frontend_user_association()` : G√®re l'association frontend
  - `ufsc_create_user_for_club()` : Cr√©e un nouvel utilisateur WordPress
  - `ufsc_get_all_clubs_for_user_association()` : R√©cup√®re les clubs pour association
  - `ufsc_get_club_by_id()` : R√©cup√®re un club par ID
  - `ufsc_get_user_display_name()` : R√©cup√®re le nom d'affichage d'un utilisateur

### 4. Base de donn√©es

#### Utilisation du champ existant
- **Table** : `wp_ufsc_clubs`
- **Champ** : `responsable_id` (int, nullable)
- **Fonctionnement** : Stocke l'ID de l'utilisateur WordPress associ√© au club
- **Synchronisation bidirectionnelle** : Mise √† jour automatique des deux c√¥t√©s (club ‚Üí utilisateur et utilisateur ‚Üí club)

## üöÄ Utilisation

### Pour les administrateurs

1. **Associer un utilisateur √† un club** :
   - **Option A - Via le club :**
     - Aller dans "UFSC" ‚Üí "Liste des clubs"
     - Cliquer sur "Modifier" pour un club
     - Dans la section "Informations g√©n√©rales", s√©lectionner un utilisateur dans "Utilisateur WordPress associ√©"
     - Sauvegarder
   
   - **Option B - Via l'utilisateur :**
     - Aller dans "Utilisateurs" ‚Üí "Tous les utilisateurs"
     - Cliquer sur "Modifier" pour un utilisateur
     - Dans la section "Association Club UFSC", s√©lectionner un club
     - Sauvegarder

2. **Cr√©er un nouveau club avec utilisateur** :
   - Aller dans "UFSC" ‚Üí "Ajouter un club"
   - Remplir les informations du club
   - S√©lectionner un utilisateur dans "Utilisateur WordPress associ√©"
   - Sauvegarder

3. **Voir les associations** :
   - Dans "UFSC" ‚Üí "Liste des clubs", la colonne "Utilisateur associ√©" affiche l'utilisateur li√© √† chaque club
   - Dans "Utilisateurs" ‚Üí "Tous les utilisateurs", l'information de club associ√© appara√Æt dans la fiche utilisateur

### Pour les clubs (affiliation frontend)

1. **Lors de l'affiliation d'un nouveau club** :
   - Remplir le formulaire d'affiliation
   - Dans la section "Utilisateur WordPress pour g√©rer le club", choisir une option :
     - **"Utiliser mon compte actuel"** : Votre compte sera associ√© au club
     - **"Cr√©er un nouveau compte utilisateur"** : Un nouveau compte sera cr√©√© avec les informations fournies
     - **"Associer un compte existant"** : S√©lectionner un utilisateur existant dans la liste
   - Finaliser l'affiliation (paiement WooCommerce)
   - L'association sera cr√©√©e automatiquement

2. **Important** : Une fois le club cr√©√© via le frontend, l'association utilisateur ne peut plus √™tre modifi√©e que par un administrateur dans le back-office.

### Pour les utilisateurs WordPress

1. **Acc√®s √† l'espace club** :
   - Une fois associ√© par un admin ou lors de l'affiliation, l'utilisateur peut acc√©der √† l'espace club frontend
   - L'acc√®s est automatiquement v√©rifi√© via `ufsc_verify_club_access()`
   - Fonctionnalit√©s disponibles : consultation des documents, gestion des licences, etc.

## üîí S√©curit√© et contr√¥les

### Validations mises en place

1. **Unicit√© de l'association** :
   - Un utilisateur ne peut √™tre associ√© qu'√† un seul club
   - Tentative d'association multiple ‚Üí erreur explicite
   - V√©rification lors de la sauvegarde

2. **Permissions** :
   - Seuls les administrateurs peuvent g√©rer les associations
   - Champ visible uniquement en interface admin
   - V√©rification `manage_options` dans le contr√¥leur

3. **Validation des donn√©es** :
   - V√©rification de l'existence de l'utilisateur
   - Sanitisation des donn√©es
   - Gestion des cas d'erreur

### Contr√¥le d'acc√®s frontend

L'acc√®s frontend utilise la fonction existante `ufsc_verify_club_access()` qui :
- V√©rifie si l'utilisateur est connect√©
- R√©cup√®re le club associ√© via `ufsc_get_user_club()`
- Compare l'ID du club demand√© avec celui de l'utilisateur

## üß™ Test et validation

### Test automatis√©
- **Fichier** : `includes/tests/user-club-association-enhancement-test.php`
- **Ex√©cution** : Ajouter `?run_ufsc_association_test=1` √† l'URL d'admin
- **Tests inclus** :
  - Existence des fonctions helper nouvelles et existantes
  - V√©rification des hooks WordPress pour profil utilisateur
  - V√©rification du sch√©ma de base de donn√©es (champ responsable_id)
  - Test des fonctions de validation et r√©cup√©ration de donn√©es
  - Test de r√©cup√©ration des utilisateurs et clubs

### Test manuel

1. **Test de l'association via le profil utilisateur** :
   - Aller dans "Utilisateurs" ‚Üí "Modifier un utilisateur"
   - V√©rifier la pr√©sence du champ "Club associ√©"
   - S√©lectionner un club et sauvegarder
   - V√©rifier que l'association appara√Æt dans la fiche club correspondante

2. **Test de l'affiliation frontend avec cr√©ation d'utilisateur** :
   - Aller sur la page d'affiliation frontend
   - Remplir le formulaire club
   - Choisir "Cr√©er un nouveau compte utilisateur"
   - Remplir les informations utilisateur
   - Soumettre et v√©rifier la cr√©ation de l'utilisateur et l'association

3. **Test de la pr√©vention des doublons** :
   - Essayer d'associer le m√™me utilisateur √† deux clubs diff√©rents
   - V√©rifier le message d'erreur appropri√©
   - Essayer de cr√©er un utilisateur avec un login/email existant
   - V√©rifier les messages d'erreur

4. **Test de l'acc√®s frontend** :
   - Se connecter avec l'utilisateur associ√©
   - Acc√©der √† l'espace club
   - V√©rifier les permissions et l'acc√®s aux fonctionnalit√©s

5. **Test de synchronisation bidirectionnelle** :
   - Modifier l'association depuis le profil utilisateur
   - V√©rifier que le changement appara√Æt dans la fiche club
   - Modifier l'association depuis la fiche club
   - V√©rifier que le changement appara√Æt dans le profil utilisateur

## üìù Notes techniques

### Compatibilit√©
- Compatible avec l'architecture existante
- Utilise le champ `responsable_id` d√©j√† pr√©sent en BDD
- Int√©gration transparente avec le syst√®me d'acc√®s frontend

### Performance
- Requ√™tes optimis√©es avec `wpdb->prepare()`
- R√©cup√©ration des utilisateurs mise en cache par WordPress
- Validation c√¥t√© serveur pour √©viter les requ√™tes inutiles

### Maintenabilit√©
- Code modulaire avec fonctions helper r√©utilisables
- Documentation inline compl√®te
- Tests automatis√©s pour validation continue

## üîß Int√©gration

### Aucune action requise
L'int√©gration est automatique car :
- Utilise les tables existantes
- S'appuie sur les fonctions d√©j√† pr√©sentes
- Compatible avec le flux existant
- Les hooks WordPress se chargent automatiquement

### Si personnalisation n√©cessaire
- **Frontend** : Modifier `includes/clubs/form-club.php` pour l'interface d'affiliation
- **Backend** : Adapter `includes/admin/user-profile-enhancement.php` pour les profils utilisateur
- **Validation** : Ajuster `includes/controllers/save-club.php` pour la logique de sauvegarde
- **Helpers** : Modifier `includes/helpers.php` pour les fonctions utilitaires
- **Styles** : Personnaliser `assets/css/frontend.css` pour l'apparence
- **JavaScript** : Adapter `assets/js/frontend.js` pour les interactions

### Hooks disponibles pour d√©veloppement
- `ufsc_before_user_club_association` : Avant association utilisateur-club
- `ufsc_after_user_club_association` : Apr√®s association utilisateur-club
- Les hooks WordPress standard pour profils utilisateur sont utilis√©s

### Structure des fichiers
```
includes/
‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îî‚îÄ‚îÄ user-profile-enhancement.php    # Gestion profil utilisateur WordPress
‚îú‚îÄ‚îÄ clubs/
‚îÇ   ‚îî‚îÄ‚îÄ form-club.php                   # Formulaire club (frontend et admin)
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ save-club.php                   # Contr√¥leur de sauvegarde
‚îú‚îÄ‚îÄ helpers.php                         # Fonctions utilitaires
‚îî‚îÄ‚îÄ tests/
    ‚îî‚îÄ‚îÄ user-club-association-enhancement-test.php  # Tests automatis√©s
```